# 11강 웹뷰

- 웹 브라우저 구현 방식 네 가지
    1. 사파리 앱 호출
    2. SFSafariViewController 구현
    3. UIWebView 구현
    4. WKWebview 구현
1. 사파리 앱 호출
    - 사파리 앱을 외부에서 실행
    - 장점 : ATS(App Transport Security)를 포함한 별다른 설정 필요 없다.
    - 예제
        
        ```swift
        let url = URL(string:"https//www.google.com/")
        UIApplication.shared.open(url!, option: [:])
        ```
        
2. SFSafariViewController 구현
    - 사파리 앱을 내부에서 구현
    - 컨트롤러 객체 형태. 스토리보드 작업이 필요없다.
    - 예제
        
        ```swift
        // SFSafariViewController를 사용하기 위한 프레임워크 반입 정의
        import SafariServices
        
        // URL 객체를 생성하고, 이를 이용하여 SFSafariViewController를 초기화
        // URLRequest 안만드는 것 주의. 
        let url = URL(string: "https://www.google.com")
        let safariViewController = SFSafariViewController(url: url!)
        
        // 생성한 safari 컨트롤러에게 화면 전환. 
        // .load 처럼 특정메소드 호출이 아닌 화면 전환 방식임에 주의.
        present(safariViewController, animated: true)
        ```
        
3. UIWebView 구현
4. WKWebview 구현
    - UIWebView의 성능개선.
    사용법도 UIWebView와 거의 동일, 아울렛 변수만 UIWebView에서 WKWebView로 바뀜.
    - 커스텀 인앱 브라우저
    - Webkit 프레임워크 반입구문 필요
    - 예제
        
        ```swift
        // WKWebView 객체 사용을 위한 프레임워크 반입 정의
        import Webkit
        
        // WKWebView 객체에 대한 아울렛 변수
        @IBOutlet var webView: WKWebView!
        
        //URLRequest 객체 생성
        let url = URL("https://www.google.com/")
        let request = URLRequest(url: url!)
        
        // request를 인자값으로 하는 load 메소드 호출
        self.webView.load(request)
        ```
        
- WKWebView를 이용한 상세페이지 예제
    - 순서
        1. 새로운 뷰 컨트롤러에 웹 뷰를 포함한 영화 상세 화면 UI를 구현한다.
        2. 뷰 컨트롤러에 대한 컨트롤러 클래스를 작성하고, 제어할 UI요소를 아울렛 변수로 정의한다.
        3. 영화 차트 목록에서 상세 화면으로의 화면 전환을 구현하면서 URL을 포함한 전달값을 처리한다.
        4. 상세 화면에서는 전달된 URL을 이용하여 웹 페이지를 로드한다.
    - prepareForSegue() 메소드
        - 트리거 세그웨이로 컨트롤러를 연결했을 때, 사용자가 선택한 셀에 대한 값을 상세 페이지에 전달하는 방법
        - 예제
            - 여기서 prepare(for:sender:) 사용 이유
                - 화면이 전환되기 전에 선택된 영화 정보를 넘겨주어야 하므로.
                - for는 어떤 세그웨이가 실행될 것인지 파악
                - sender는 메소드에게 메세지를 보낸 대상을 가리키는 값. 즉, 세그웨이를 실행한 객체.
                (매뉴얼 세그웨이 경우 sender에 버튼이나 셀, 뷰 컨트롤러 등의 대상 객체 참조 정보 전달)
            - indexPath(for:)
                - 인자값으로 전달된 셀 객체가 테이블 뷰에서 몇 번째 행에 해당하는지에 대한 정보를 indexPath 객체 형태로 반환
            
            ```swift
            // MARK: - 화면 전환 시 값을 넘겨주기 위한 세그웨이 관련 처리
            extension ListViewController {
                
                override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
            // 실행된 세그웨이의 식별자가 segue_detail 이면
                    if segue.identifier == "segue_detail" {
                        
            // 사용자가 클릭한 행을 찾아낸다.
                        let path = self.tableView.indexPath(for: sender as! MovieCell)
            
            // 행 정보를 통해 선택된 영화 데이터를 찾은 다음, 목적지 뷰 컨트롤러의 mvo변수에 대입한다.
                        let detailVC = segue.destination as? DetailViewController
                        detailVC?.mvo = self.list[path!.row]
                    }
                }
            }
            ```
            
    - DetailViewController 파일
        - 예제
            
            ```swift
            //
            //  DetailViewController.swift
            //  MyMovieChart-1
            //
            //  Created by 이형주 on 2022/05/17.
            //
            
            import Foundation
            import UIKit
            import WebKit
            
            class DetailViewController: UIViewController{
                
                @IBOutlet weak var wv: WKWebView!
                var mvo: MovieVO!
                
                @IBOutlet weak var spinner: UIActivityIndicatorView!
                
                override func viewDidLoad() {
                    self.wv.navigationDelegate = self
            	      
            // 네비게이션 바의 타이틀에 영화명 출력
                    let navibar = self.navigationItem
                    navibar.title = self.mvo.title
                    
            // URLRequest 인스턴스 생성
                    let url = URL(string: self.mvo.moreInfo!)
                    let req = URLRequest(url: url!)
                   
            // 생성된 URLRequest 인스턴스를 인자값으로 load 메소드 호출 
                    self.wv.load(req)
                }
            }
            ```
            
    - NSMutableDictionary
        - VO가 값이 늘어낼 때마다 멤버 변수를 추가하는 것이 불편할 때 대신 사용 가능
        - (이번 예제에선 사용 안함)
        - 예제
            
            ```swift
            class Foo: UIViewController {
            	var extraValue = NSMutableDictionary()
            	
            	func saveInfo() {
            		self.extraValue["title"] = "슈퍼맨"
            		self.extraValue["description"] = "외계인이야기"
            		self.extraValue["rating"] = 3.8
            	}
            }
            ```
            
- WKWebView 속성들
    - load(_:)
        - 웹페이지(HTML파일) 로딩하는 메소드
        - 인자값으로 URLRequest(웹 페이지를 요청하기 위한 조건이 정의된 객체) 객체를 받음.
        - 앱 내부에 저장된 로컬HTML은 로딩 불가 (loadHTMLString(_:baseURL:) 사용)
        - 비동기 메소드
    - stopLoading()
        - 웹 페이지 로딩 도중 중단하고자 할 때
    - isLoading 프로퍼티
        - 웹 페이지의 로딩 진행 여부 확인
        - Bool 타입 반환
        - load(_:) 메소드가 처리하는 진행 과정에 따라 자동으로 설정되는 값. 읽기 전용(수정 불가).
    - goBack(), goForward()
        - 웹 페이지를 보는 도중에 이전/다음 URL로 이동할 시
    - 웹 뷰와 델리게이트 패턴
        - WKWebView는 델리게이트 패턴을 통해 웹 페이지의 로딩 상황을 추적하고, 콘텐츠나 사용자의 액션을 제어할 수 있도록 지원한다.
        - WKNavigationDelegate / WKUIDelegate 메소드 사용
        - WKNavigationDelegate
            - 주로 웹킷 뷰의 로딩 상황을 추적하거나 제어하는 내용
            - webView(_:didcidePolicyFor:decisionHandler:)
                - 웹 페이지 로딩 결정 메소드
                - decisionHandler(.cancel) 함수로 사용.(허용은 .allow)
                - 웹 뷰 내에서 허용하고 싶지 않은 요청이나 URL 선택적으로 차단 가능
            - webView(_:didStartProvisionalNavigation:)
                - 웹 뷰가 콘텐츠를 로드하기 시작할 때 호출되는 메소드
                - URL이 유효하지 않거나 옵셔널 상태일때도 호출
            - webView(_:didCommit:)
                - 웹 뷰가 웹 콘텐츠를 받기 시작할 때 호출되는 메소드
                - 대표적인 것이 로딩 상태 표시(Activity Indicator View)
            - webView(_:didFinish:)
                - 웹 뷰가 콘텐츠 로딩을 완전히 마쳤을 때 호출되는 메소드
            - webView(_:didFail:withError:)
                - 웹 페이지를 불러오던 도중콘텐츠 로딩이 실패했을 때 호출되는 메소드
                - URL이 잘못되거나 네트워크 문제로 응답을 아예 받지 못한 것과 다름
                → 해당 경우는 webView(_:didFailProvisionalNavigation:withError:) 메소드 사용
- 델리게이트 패턴을 이용한 웹 뷰의 로딩 처리
    - 목표
        - 웹 뷰가 HTML 페이지를 불러오는 동안 로딩 아이콘 표시
        - 웹 뷰가 HTML 페이지 로딩을 실패했을 때 실패 메세지 표시
    - 예제
        
        ```swift
        //
        //  DetailViewController.swift
        //  MyMovieChart-1
        //
        //  Created by 이형주 on 2022/05/17.
        //
        
        import Foundation
        import UIKit
        import WebKit
        
        class DetailViewController: UIViewController{
        
        override func viewDidLoad() {
        	@IBOutlet weak var wv: WKWebView!
        	    var mvo: MovieVO!
        	@IBOutlet weak var spinner: UIActivityIndicatorView!
        // WKNAvigationDelegate의 델리게이트 객체 지정
                self.wv.navigationDelegate = self
        // ...중략...
        }
        
        // MARK: - WKNavigationDelegate Protocol 구현
        extension DetailViewController: WKNavigationDelegate{
            func webView(_ webView: WKWebView, didCommit navigation: WKNavigation!) {
                self.spinner.startAnimating()
            }
            func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
                self.spinner.stopAnimating()
            }
            func webView(_ webView: WKWebView, didFail navigation: WKNavigation!, withError error: Error) {
                self.spinner.stopAnimating()
                self.alert("상세페이지를 읽어오지 못했습니다."){
                    _ = self.navigationController?.popViewController(animated: true)
                }
            }
        
        }
        
        // MARK: - 심플한 경고창 함수 정의용 익스텐션
        extension UIViewController {
            func alert(_ message: String, onClick: (() -> Void)? = nil){
                let controller = UIAlertController(title: nil, message: message, preferredStyle: .alert)
                controller.addAction(UIAlertAction(title: "OK", style: .cancel){(_) in
                    onClick?()
                })
                DispatchQueue.main.async {
                    self.present(controller, animated: true)
                }
            }
        }
        ```
        
        - 특징
            - WKNAvigationDelegate의 델리게이트 객체 지정
                - DetailViewController 클래스에다 델리게이트 메소드를 구현해 둘 테니 웹 뷰에 변화가 일어나면 그에 맞는 메소드를 호출해달라는 뜻
            - 경고창 구문 익스텐션화
                - func alert(_ message: String, onClick: (() -> Void)? = nil){
                    - 이 부분은 직접 작성한 부분
                - OK 버튼을 가지는 단순 경고창으로, 버튼 클릭시에 처리할 이벤트가 생기면 콜백 함수로 전달하기 위해 두번째 매개변수 옵셔널처리.
